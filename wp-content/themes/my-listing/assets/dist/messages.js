!function(e){"function"==typeof define&&define.amd?define("messages",e):e()}(function(){"use strict";function n(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var e=function(){function s(e){for(var t in function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),this.data=e)this[t]=e[t];this.$=jQuery,this.post=this.$.post,this.syncStatus=!0,this.startTime=0,this.endTime=0,this.syncDelay=3e3,this.nextSyncDelay=this.syncDelay,this.failedRequests=0,this.failedSyncDelay=6e4,this.settings=ml_msg,this.deletedGroups=[],this.loading=!1,this._blocked=!1,this._loaded={},this._endReached=[],this._queList={},this._activitiesCount={},this._opponents={},jQuery(document).ready(this.sync.bind(this))}return function(e,t,s){t&&n(e.prototype,t),s&&n(e,s)}(s,[{key:"sync",value:function(){var t=this;this.post(CASE27.ajax_url,{action:"mylisting_sync_messages",st:this.startTime,et:this.endTime,dg:this.deletedGroups,opponent_id:this.opponentId,async:!0,cache:!1}).done(function(e){if(!e.success||!e.data.hasOwnProperty("ml")||!e.data.hasOwnProperty("st")||!e.data.hasOwnProperty("et")||e.data.st.length<10)return t.failedRequests++,!1;10<=e.data.st.toString().length&&(t.startTime=e.data.st,t.endTime=e.data.et),t.$.isEmptyObject(e.data.ml)||t._addMessages(e.data.ml),t.nextSyncDelay=t.syncDelay,t.failedRequests=0}).fail(function(e){t.failedRequests++,t.nextSyncDelay=t.failedRequests*t.failedSyncDelay}).complete(function(){if(t.isLoading=!1,!t.syncStatus||5<=t.failedRequests)return!1;setTimeout(t.sync.bind(t),t.nextSyncDelay)})}},{key:"deleteGroup",value:function(e){return void 0!==this.messages[e.op.id]&&delete this.messages[e.op.id],this.messages=Object.assign({},this.messages),this.post(CASE27.ajax_url,{action:"mylisting_delete_conversation",seckey:e.dcn,opponent_id:e.op.id})}},{key:"loadMore",value:function(e,t){var s=this;if(!this.opponentId||-1!==this._endReached.indexOf(this.opponentId))return null;(e=void 0===e)&&this._decreaseActivities(this._activitiesCount[this.opponentId]),this.loading=!0,this.post(CASE27.ajax_url,{action:"mylisting_read_conversation",opponent_id:this.opponentId,mark_all_read:e,offset:Object.keys(this.messages[this.opponentId]).length}).done(function(e){return s.loading=!1,s.$.isEmptyObject(e.data.ml)?(s._endReached.push(s.opponentId),"function"==typeof t?t(!0):null):(s._addMessages(e.data.ml),"function"==typeof t?t():null)})}},{key:"send",value:function(e){var s=this;return this._addToQuelist({opid:this.opponentId,message:e}),this.post(CASE27.ajax_url,{action:"mylisting_send_message",receiver_id:this.opponentId,seckey:this.settings.smn,message:e}).done(function(e){if(e&&void 0!==e.success&&!e.success){var t=1e3*ml_msg.bt;new MyListing.Dialog({message:e.data,timeout:t,dismissable:!1}),s._blocked="long",setTimeout(function(){s._blocked=!1},t)}})}},{key:"deleteMsg",value:function(e){var t=this;for(var s in this.messages[e.op.id])if(e.id===this.messages[e.op.id][s].id){delete this.messages[e.op.id][s];break}return this.messages[e.op.id]=this.messages[e.op.id].filter(function(){return!0}),this.messages=Object.assign({},this.messages),this.post(CASE27.ajax_url,{action:"mylisting_delete_message",message_id:e.id,seckey:e.dm}).complete(function(){t.scrollToEnd=!0})}},{key:"setOpponent",value:function(e){this.opponentId=e,this.scrollToEnd=!0,this.messages[e]=this.messages[e]||[],this._loaded[e]=this._loaded[e]||[],this.conversation=this.messages[e]}},{key:"getOpponent",value:function(e){return void 0!==this._opponents[e]&&this._opponents[e]}},{key:"cacheOpponents",value:function(e){for(var t in e)this._opponents[t]=e[t]}},{key:"loadUser",value:function(t,s){var n=this;if(void 0!==this._opponents[t])return s(this._opponents[t]);this.post(CASE27.ajax_url,{action:"mylisting_recipients",user_id:t}).done(function(e){return e.success&&e.data[t]?(n.cacheOpponents(e.data),s(n._opponents[t])):s(!1)})}},{key:"_addToQuelist",value:function(e){var t=e.opid||this.opponentId,s=this.getOpponent(t);if(!s)return null;void 0===this.messages[t]&&(this.messages[t]=[],this._loaded[t]=[]),void 0===this._queList[t]&&(this._queList[t]=0),this._queList[t]=this._queList[t]+1,this.messages[t].push({id:"_temp_message",message:e.message,op:s,sender:ml_msg.cu.id,utime:moment().unix(),loading:!0,seen:1}),this.messages=Object.assign({},this.messages)}},{key:"_decreaseActivities",value:function(e){var s=this;this.activities=this.activities-e,this.activities<0&&(this.activities=0),this.$.each(this.messages[this.opponentId],function(e,t){s.messages[s.opponentId][e].seen=1})}},{key:"_clearQueList",value:function(e){if(void 0===this._queList[e]||this._queList<=0||void 0===this.messages[e])return null;var t=[];for(var s in this.messages[e]){var n=this.messages[e][s];"_temp_message"!==n.id&&t.push(n)}this.messages[e]=t}},{key:"_addMessages",value:function(e){var n=this,i=[];this.$.each(e,function(e,t){var s=t.op.id;if(-1===i.indexOf(s)&&i.push(s),n._opponents[s]=t.op,void 0===n.messages[s]&&(n.messages[s]=[],n._loaded[s]=[],n._activitiesCount[s]=0),-1!==n._loaded[s].indexOf(e))return null;parseInt(t.seen)||t.op.id===n.opponentId||0!==parseInt(t.seen)||parseInt(t.sender)===parseInt(ml_msg.cu.id)?t.seen=1:(n.activities=n.activities+1,n._activitiesCount[s]=n._activitiesCount[s]+1),n._clearQueList(s),n.messages[s].push(t),n._loaded[s].push(e)}),i.forEach(function(e){n.messages[e]=n.messages[e].sort(function(e,t){return e.utime>t.utime?1:-1})}),this.messages=Object.assign({},this.messages)}}]),s}(),t={props:["chat"],template:"#ml-inbox",computed:{isMessages:function(){for(var e in this.chat.messages)if(this.chat.messages[e].length)return!0;return!1},isLoading:function(){return this.chat.isLoading}},methods:{compose:function(){this.chat.mode="compose"}},components:{messages:{props:["chat","isLoading"],data:function(){return{deleteConfirm:null}},computed:{messageList:function(){var e=[];for(var t in this.chat.messages)if(Object.keys(this.chat.messages[t]).length){var s=this.chat.messages[t][Object.keys(this.chat.messages[t]).length-1],n=0<parseInt(s.seen)||parseInt(s.sender)===parseInt(ml_msg.cu.id);e.push({opid:t,data:s,seen:n})}return e.sort(function(e,t){var s=parseInt(e.data.seen),n=parseInt(t.data.seen);return s===n||parseInt(e.data.sender)===parseInt(ml_msg.cu.id)||parseInt(t.data.sender)===parseInt(ml_msg.cu.id)?e.data.utime<t.data.utime?1:-1:n<s?1:-1})}},methods:{timestamp:function(e){return moment.unix(e).fromNow()},deleteConversation:function(e){if(this.deleteConfirm!==parseInt(e.op.id))return this.deleteConfirm=parseInt(e.op.id);this.chat.deleteGroup(e),this.deleteConfirm=null},open:function(e){if(this.deleteConfirm)return null;this.chat.setOpponent(e.op.id),this.chat.loadMore(),this.chat.mode="conversation"},opponentInfo:function(e){return e.op.name},isDelete:function(e){return parseInt(e.opid)===this.deleteConfirm},cancelDelete:function(){this.deleteConfirm=null}},template:"#ml-inbox-messages"}}},s={props:["chat","conversation"],template:"#ml-conversation",data:function(){return this._initialState()},created:function(){this.initialize()},watch:{message:function(){var e=this.message.match(/\n/g),t=e?e.length:1;if(5<t)return null;this.rows=t},"chat.opponentId":function(){this.initialize()}},computed:{isLoading:function(){return this.chat.loading},disable:function(){return!!this.chat._blocked},disableMessage:function(){return!this.opponent}},methods:{initialize:function(){var t=this;this.endTime(),Object.assign(this.$data,this._initialState()),this.chat.loadUser(this.chat.opponentId,function(e){if(!e)return new MyListing.Dialog({message:ml_msg.strings.notAvailable}),t.inbox();t.init=!1,t.opponent=t.chat._opponents[t.chat.opponentId],t.startTime(),t.$root.mobile.matches||t.$nextTick(function(){jQuery(t.$el).find("#ml-conv-textarea").focus()})})},inbox:function(){this.chat.opponentId=0,this.chat.mode="inbox"},send:function(e){return!(!e||!e.shiftKey)||(this.message=jQuery.trim(this.message),!this.message.length||this.chat._blocked?null:(this.disableSend(),this.$root.chat.scrollToEnd=!0,this.chat.send(this.message),void(this.message="")))},goToInbox:function(){this.chat.opponentId=0,this.chat.mode="inbox"},disableSend:function(){var e=this;this.chat._blocked="short",setTimeout(function(){"short"===e.chat._blocked&&(e.chat._blocked=!1)},ml_msg.sd)},deleteConversation:function(){if(void 0===this.chat.messages[this.chat.opponentId]||!this.chat.messages[this.chat.opponentId].length)return this.goToInbox();var e=this.chat.messages[this.chat.opponentId][0];if(this.deleteConfirm!==parseInt(e.op.id))return this.deleteConfirm=parseInt(e.op.id);this.chat.deleteGroup(e),this.deleteConfirm=null,this.goToInbox()},isDelete:function(){return this.chat.opponentId===this.deleteConfirm},cancelDelete:function(){this.deleteConfirm=null},startTime:function(){this._interval=setInterval(this.updateTime.bind(this),4e4)},endTime:function(){clearInterval(this._interval)},updateTime:function(){this.messages=Object.assign([],this.conversation)},_initialState:function(){return{init:!0,opponent:{},messages:{},message:"",deleteConfirm:null,maxLength:ml_msg.mcl,rows:1,_sd:ml_msg.sd}}},components:{messages:{props:["conversation","opponent","chat"],data:function(){return{deleteConfirm:null,_interval:null}},watch:{conversation:function(){this.scrollWindow()}},mounted:function(){this.bindScroll()},computed:{messages:function(){return this.conversation},isMessages:function(){return Object.keys(this.conversation).length},isLoading:function(){return this.chat.loading}},methods:{conversationClass:function(e){return parseInt(e.sender,10)===parseInt(ml_msg.cu.id,10)?"responder-2":"responder-1"},timestamp:function(e){return moment.unix(e).fromNow()},deleteMsg:function(e){if(this.deleteConfirm!==parseInt(e.id))return this.deleteConfirm=parseInt(e.id);this.$root.chat.deleteMsg(e)},isDelete:function(e){return parseInt(e.id)===this.deleteConfirm},cancelDelete:function(){this.deleteConfirm=null},isOpponent:function(e){return parseInt(e.sender)===parseInt(e.op.id)},senderAvatar:function(e){return parseInt(e.sender)===parseInt(e.op.id)?e.op.avatar:ml_msg.cu.avatar},scrollListener:function(e){var t=this;if(50<e.target.scrollTop)return null;this.$root.chat.scrollToEnd=!1,this.unbindScroll(),this.$root.chat.loadMore(!0,function(e){t.$el.scrollTop<55&&(t.$el.scrollTop=55),t.bindScroll()})},bindScroll:function(){this.$el.addEventListener("scroll",this.scrollListener)},unbindScroll:function(){this.$el.removeEventListener("scroll",this.scrollListener)},scrollWindow:function(){if(!this.$root.chat.scrollToEnd)return null;this.$el.scrollTop=this.$el.scrollHeight},linkify:function(e){var t,s,n,i=e.message;return"_temp_message"===e.id?i:(t=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,s=/(^|[^\/])(www\.[\S]+(\b|$))/gim,n=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,i.replace(t,'<a href="$1" target="_blank" rel="nofollow">$1</a>').replace(s,'$1<a href="http://$2" target="_blank" rel="nofollow">$2</a>').replace(n,'<a href="mailto:$1">$1</a>'))}},updated:function(){this.scrollWindow()},template:"#ml-conversation-messages"}},beforeDestroy:function(){this.endTime()}},i={props:["chat"],template:"#ml-compose-message",data:function(){return{opponentId:0,message:"",selected:2,url:CASE27.ajax_url,options:null}},computed:{opponentName:function(){return this.chat.getOpponent(this.opponentId).name}},watch:{opponentId:function(e){this.chat.setOpponent(this.opponentId),this.chat.mode="conversation",this.chat.loadMore(),this.message=""}},methods:{inbox:function(){this.chat.mode="inbox"}},components:{select2:{props:["chat","options","value","url"],template:"#ml-opponent-list",data:function(){var s=this;return{ajaxOptions:{url:this.url,type:"POST",dataType:"json",delay:250,data:function(e){return{action:"mylisting_recipients",term:e.term,page:e.page}},processResults:function(e,t){return e.success&&s.chat.cacheOpponents(e.data),t.page=t.page||1,{results:s.opponents,pagination:{more:30*t.page<[].total_count}}},cache:!0}}},computed:{opponents:function(){var e=[];for(var t in this.chat._opponents)e.push({id:t,text:this.chat._opponents[t].name});return e}},mounted:function(){var t=this;this.el=jQuery(this.$el).select2({data:this.options,placeholder:ml_msg.strings.selectUser,ajax:this.ajaxOptions}).on("change",function(e){t.$parent.opponentId=e.currentTarget.value,t.$emit("input",e.currentTarget.value)})},destroyed:function(){this.el.off().select2("destroy")}}}};window.MyListing.Messages=new Vue({el:"#ml-message-btn",data:{modal:jQuery("#ml-messages-modal"),mobile:window.matchMedia("screen and (max-width: 790px)"),chat:new e({mode:!1,messages:{},conversation:[],pending:{},activities:0,opponentId:0,compose:!1,scrollToEnd:!0,allRead:!1,isLoading:!0,_lastMode:"inbox"})},created:function(){this.mobile.matches&&(jQuery("#ml-messages-modal").on("shown.bs.modal",function(){jQuery("html, body").addClass("disable-scroll")}),jQuery("#ml-messages-modal").on("hidden.bs.modal",function(){jQuery("html, body").removeClass("disable-scroll")}))},mounted:function(){this.$el.addEventListener("touchmove",MyListing.Helpers.debounce(function(){document.body.scrollTop=0},50))},watch:{"chat.activities":function(e){e=parseInt(e),isNaN(e)&&(e=0);var t=jQuery("#ml-chat-activities").html("<span>"+e+"</span>");return e<=0?t.hide():t.show()},"chat.messages":function(e){if(!this.chat.opponentId)return[];this.chat.conversation=this.chat.messages[this.chat.opponentId]},"chat.opponentId":function(e){if(parseInt(e))return this.chat.mode="conversation",e;this.chat.mode="inbox",this.chat.conversation=[]}},methods:{toggle:function(){var e=this.chat._lastMode,t=this.chat.mode;this.chat._lastMode=t,this.chat.mode=e},close:function(){this.modal.modal("hide")},open:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;this.chat.setOpponent(e),this.modal.modal("show")}},components:{inbox:t,conversation:s,compose:i}})});

//# sourceMappingURL=messages.js.map
